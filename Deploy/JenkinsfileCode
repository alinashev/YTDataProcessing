pipeline {
    agent any
    stages {
        stage('Submit Stack') {
            steps {
                withCredentials([aws(accessKeyVariable:'AWS_ACCESS_KEY_ID', credentialsId:'aws-cresds1', secretKeyVariable:'AWS_SECRET_ACCESS_KEY')])
                {
                sh  '''
                    cd LambdaPuller && zip -r9 index.zip .
                    aws s3 cp index.zip s3://a-tech-bucket/LambdaPullerCode/index.zip
                    rm index.zip

                    aws lambda update-function-code \
                      --function-name A-test-send-01\
                      --region us-east-2 \
                      --s3-bucket a-tech-bucket\
                      --s3-key LambdaSenderCode/index.zip

                    cd ..
                    cd LambdaSender && zip -r9 index.zip .
                    aws s3 cp index.zip s3://a-tech-bucket/LambdaSenderCode/index.zip
                    rm index.zip

                    aws lambda update-function-code \
                      --function-name A-test-pull-01\
                      --region us-east-2 \
                      --s3-bucket a-tech-bucket\
                      --s3-key LambdaPullerCode/index.zip
                    '''
                }
              }
             }
           }
         }